minimum_cumulusci_version: '3.38.0'
project:
    name: NPSP-PostInstallSteps
    package:
        name: NPSP-PostInstallSteps
        api_version: '50.0'
    dependencies:
        - github: 'https://github.com/SalesforceFoundation/NPSP'
    git:
        default_branch: 'main'
        repo_url: https://github.com/SFDO-Alliances/NPSP-PostInstallSteps
    source_format: sfdx

tasks:
    robot:
        options:
            suites: robot/NPSP-PostInstallSteps/tests
            options:
                outputdir: robot/NPSP-PostInstallSteps/results

    robot_testdoc:
        options:
            path: robot/NPSP-PostInstallSteps/tests
            output: robot/NPSP-PostInstallSteps/doc/NPSP-PostInstallSteps_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 75


flows:
    install_template:
        steps:
            1:
                task: update_dependencies
            2:
                task: deploy_pre
                ui_options:
                    recordtypes:
                        name: Opportunity and Account Record Types
            3:
                task: dx_convert_from
                when: project_config.project__source_format == "sfdx" and not org_config.scratch
            4:
                task: unschedule_apex
            5:
                task: update_package_xml
                when: project_config.project__source_format != "sfdx" or not org_config.scratch
            6:
                task: deploy
                when: project_config.project__source_format != "sfdx" or not org_config.scratch
            7:
                task: deploy_post
            8:
                task: update_admin_profile

plans:
  install:
    slug: install
    title: Install NPSP Post Install Template
    tier: primary
    description: NPSP Post Installation steps template
    is_listed: True
    checks:
      - when: "not tasks.check_my_domain_active()"
        action: error
        message: "Please enable My Domain in your org prior to installing."    
      - when: "'npsp' not in tasks.get_installed_packages()"
        action: warn
        message: "Nonprofit Success Pack will be installed into the Salesforce Org."
        steps:
            1:
                task: unschedule_apex
                ui_options:
                    name: Unschedule Scheduled Apex Jobs
                    is_required: False
                    is_recommended: True
            2:
                task: update_dependencies
                ui_options:
                    name: Install/Update Nonprofit Success Pack
            3:
                task: dx_convert_from
                ui_options:
                    name: Convert Unmanaged Source
            4:
                task: deploy
                ui_options:
                    name: Deploy Extra Configuration (Picklist, Page Layouts, etc)
                    is_required: False
                    is_recommended: False
            5:
                task: update_admin_profile
                ui_options:
                    name: Update Profile  
            6:
                task: load_dataset
                ui_options:
                    name: Load Reciprocal Relationship Data
                    is_required: True
                    is_recommended: True   